{% extends 'admin.html' %}
{% load bootstrap %}
{% block titulo %}
Editar Macrocliente
{% endblock %}
{% block css %}
<link href="{{ STATIC_URL }}/css/smoothness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
<style type="text/css" xmlns="http://www.w3.org/1999/html"></style>
{% endblock %}
{% block seccion-contenido %}
<input id='toto' type="hidden" value=''>
<form method="POST" action="" enctype="multipart/form-data" >{% csrf_token %}

    <div class="panel panel-default">
        <div class="panel-heading">
            <h4>Datos Macrocliente</h4>
        </div>
        <div class="panel-body">
            <div class="col-sm-6">
                {{ formulario.marca | bootstrap }}
            </div>
            <div class="col-sm-6">
                 {{ formulario.submarca|bootstrap}}
            </div>
            <div class="col-sm-6">
                {{ formulario.nombre | bootstrap}}
            </div>
            <div class="col-sm-6">
                {{ formulario.telefono | bootstrap }}
            </div>
            <div class="col-sm-6">
                {{ formulario.rif | bootstrap }}
            </div>
            <div class="col-sm-12">
                {{ formulario.direccion_fiscal | bootstrap }}
            </div>
            <div class="col-sm-12">
                {{ formulario.descripcion | bootstrap }}
                <!--Empieza el mapaaaaaaaaaaaaaaaaaaaaa -->
            </div>
        </div>
    </div>
       <div class="panel panel-default">
        <div class="panel-heading">
            <h4>Sedes</h4>
        </div>

            <div class="panel-body">
                <div class="col-sm-4">
                    <label class="control-label">
                        Nombre
                    </label>
                </div>
                <div class="col-sm-4">
                    <label class="control-label">
                        Locación
                    </label>
                </div>
                {% for direccion in dirs %}
                    <div id='b-{{ direccion.id }}' class="col-sm-12">
                        <div id='sedeNom-{{ direccion.id }}' class='col-sm-4'>
                            {{ direccion.nombre }}
                            <input type="hidden" name="{{ direccion.direccion.nombre }}" value="{{ direccion.nombre }}">
                        </div>
                        <div class='col-sm-4'>
                            {{ direccion.direccion.nombre }}
                            <input type="hidden" name="sedes" value="{{ direccion.direccion.nombre }}">
                        </div>
                        <div class='col-sm-4'>
                            <input type='button' value='Eliminar' onclick="eliminarSede('b-{{ direccion.id }}')" class='btn btn-xs btn-danger'>
                            <input type='hidden' id="sedeId-{{ direccion.id }}" value='hola'>
                        </div>
                        <br><hr/>
                    </div>
                {% endfor %}



            <div id="tablaSede" name="0" class="col-sm-12"></div>
            <div class="col-sm-4">

                <input type="text" name="nombreSede" class="form-control" id="inputNombreSede">
            </div>
            <div class="col-sm-8">

                <input type="text" name="locacionSede" class="form-control" id="inputSede" onkeyup="aucomloc(this.id)">
            </div>
            <div class="col-sm-6">
                <input type="button" class="btn btn-xs btn-primary" onclick="agregarSede()" value="Agregar Sede">
            </div>

        </div>
    </div>
                    <input type="submit" class="btn btn-primary" value="guardar">
</form>

<div style="display: none"><button data-toggle="modal" href="#addressModal" type='' class="btn btn-block btn-default" id='addresstoto'><span class="glyphicon glyphicon-map-marker"></span> Select Address</button></div>

    <div class="modal fade" id="addressModal" tabindex="-1" role="dialog" aria-labelledby="addressModalLabel" aria-hidden="true"> <!-- Revisar usabilidady ARIA -->
     <div class="modal-dialog modal-direccion">
       <div class="modal-content modal-address">
         <div class="modal-header">
           <button id="close" type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
           <h2 class="modal-title">Seleccionar Direcciones</h2>
         </div>
		 <div class="modal-body">
			 {% include "staff/incluir_libreta.html" %}
		 </div>
       </div><!-- /.modal-content -->
     </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

<div id='dialog'></div>
{% endblock %}

{% block js %}
<script type="text/javascript">

window.onload = function(){

    if(document.getElementById("id_marca").value<1){
        //{#  document.getElementById("id_marca").innerHTML = "<option></option>";#}
        //document.getElementById("id_submarca").innerHTML = "<option></option>";

    }else{
        document.getElementById("id_submarca").innerHTML = "<option value=\"{{ macrocliente.submarca.id }}\">{{ macrocliente.submarca.nombre }}</option>";
        {% for submarca in submarcas %}
            if ('{{ submarca }}'!='{{macrocliente.submarca}}'){
                document.getElementById("id_submarca").innerHTML += "<option value=\"{{ submarca.id }}\">{{ submarca.nombre }}</option>";
            }
        {% endfor %}

    }
}


    $('#id_marca').on('change',ajax_submar);
    $("#id_email").on('keyup',aucomemail);
    $('dialog').dialog("option", "hide");


function ajax_submar(){

    var select_marca = $('#id_marca').val();

    if(select_marca>0){
        $.ajax({

            beforeSend: function(){

                document.getElementById("id_submarca").innerHTML = "<option>Cargando...</option>";

            },
            data:{'id': select_marca},
            url:'/macrocliente_ajax/',
            type: 'get',
            error:function(a,b,c){

                $('#alertas-ajax').addClass('alert');
                $('#alertas-ajax').addClass('alert-danger');
                document.getElementById('alertas-ajax').innerHTML = "<button type='button' class='close' data-dismiss='alert' aria-hidden='True'>&times;</button>Hubo un error de comunicación "+c+"</div>"
                console.log(c);
            }

        }).done(function(data){

            document.getElementById("id_submarca").disabled = false;
            document.getElementById("id_submarca").innerHTML = "<option>---------</option>";
            for(var i=0; i<data.length; i++){
                document.getElementById("id_submarca").innerHTML = document.getElementById("id_submarca").innerHTML+"<option value="+data[i].pk+">"+data[i].fields.nombre+"</option>";
            }
        });
    }else{

        document.getElementById("id_submarca").innerHTML = "<option>---------</option>";
        document.getElementById("id_submarca").disabled = true;

    }
}

function eliminarSede(sede){

    document.getElementById(sede).parentNode.removeChild(document.getElementById(sede));

}

function agregarSede(){

    var i = document.getElementById('tablaSede').getAttribute('name');
    var direccion = document.getElementById('inputSede').value;

    $.ajax({

        data:{'direc':direccion},
        url:'/agregar_sede_macrocliente_ajax/',
        type:'GET'

    }).done(function(info){

        if(document.getElementById('inputNombreSede').value != ''){

            if(info.status==1){

                i = parseInt(i);
                document.getElementById('tablaSede').innerHTML += "<div id=b-"+i+"><div id=sedeNom-"+i+" class='col-sm-4'>"+document.getElementById('inputNombreSede').value+"<input type=\"hidden\" name=\""+ document.getElementById('inputSede').value +"\" value=\""+ document.getElementById('inputNombreSede').value +"\"></div><div class='col-sm-4'>"+document.getElementById('inputSede').value+"<input type=\"hidden\" name=\"sedes\" value=\""+ document.getElementById('inputSede').value +"\"></div><div class='col-sm-4'><input type='button' value='Eliminar' onclick=eliminarSede('b-"+i+"') class='btn btn-xs btn-danger'><input type='hidden' id=sedeId-"+i+" value='hola'></div><br><hr/></div>";
                i++;
                document.getElementById('tablaSede').setAttribute('name',i);
                document.getElementById('inputNombreSede').value = '';
                document.getElementById('inputSede').value ='';

            }else{

                if(confirm("La locacion no existe!\nDesea agregar a la libreta de direcciones?")){
                    document.getElementById('toto').setAttribute('value','inputSede');
                    document.getElementById('addresstoto').click();
                }

            }

        }else{

            alert("El nombre de la sede no puede estar vacío.");

        }

    });

}

function aucomloc(id_input){

    var ajax_loc = document.getElementById(id_input).value;
    var a=id_input;

    $.ajax({
        data:{'locacion':ajax_loc},
        url:'/locacion_ajax/',
        type:'GET'
    }).done(function(dominio){

        var locaciones_finales=[];

        for(var i=0; i<dominio.length; i++){
            locaciones_finales.push([dominio[i].fields.nombre].toString());
        }

        $('#'+a).autocomplete({
            source: locaciones_finales
        });

    });
}

</script>
{% endblock %}

{% block js-nivel-3 %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/maps.js"></script>
<script type="text/javascript">

$(document).ready(function(){

        setTimeout(function() {
            var latlng = new google.maps.LatLng(34.0883632,18.3788381);
            var myOptions = {
                zoom: 10,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

            createMarker(latlng);
        }, 500);

});

function ajax_guardar(){
    var nombre = $('#nombre').val();
    var direccion = $('#formatedAddress').val();
    var descripcion = $('#descripcion').val();
    var latlng = $('#latlng').val();
    var iden;




    $.ajax({
        data:{'nombre': nombre, 'direccion': direccion, 'descripcion': descripcion, 'latlng': latlng},
        url:'/guardar_direccion_ajax/',
        type: 'get',
        error:function(a,b,c){

            $('#alertas-ajax').addClass('alert');
            $('#alertas-ajax').addClass('alert-danger');
            document.getElementById('alertas-ajax').innerHTML = "<button type='button' class='close' data-dismiss='alert' aria-hidden='True'>&times;</button>Hubo un error de comunicación "+c+"</div>"
            console.log(c);
        }

    }).done(function(data){
        for(var i=0; i<data.length; i++){
            $('#content').append("<tr><td onclick=obtenerDireccion('"+ data[i].fields.nombre +"')>"+ data[i].fields.nombre +"</td><td onclick=obtenerDireccion('"+ data[i].fields.nombre +"')>"+ data[i].fields.direccion +"</td><td><button type=\"button\" class=\"btn btn-default btn-danger btn-xs\" onclick=\"deleteAlert(" + data[i].pk + ")\">Eliminar</button></td></tr>");
        }

        if(document.getElementById("toto") != null){
            document.getElementById(document.getElementById("toto").value).value = data[0].fields.nombre;

            if($('#'+$('#toto').val()).hasClass('editable')){

                iden = $('#toto').val().split('-');
                iden = iden[1];

                $.ajax({

                    url:'/editar_funcion',
                    data:{'accion':'4', 'iden':iden, 'nomb':nom},
                    type:'GET'

                }).done(function(data){


                    $('#'+$('#toto').val()).html(data.nombre);

                });

            }

            document.getElementById("close").click();
        }
    });

}



function obtenerDireccion(nom){

    var iden;
    if(document.getElementById("toto") != null){
        document.getElementById(document.getElementById("toto").value).value = nom;

        if($('#'+$('#toto').val()).hasClass('editable')){



            iden = $('#toto').val().split('-');
            iden = iden[1];

            $.ajax({

                url:'/editar_funcion',
                data:{'accion':'4', 'iden':iden, 'nomb':nom},
                type:'GET'

            }).done(function(data){


                $('#'+$('#toto').val()).html(data.nombre);

            });

        }

        document.getElementById("close").click();

    }

}

function deleteAlert(id, row){

    if (confirm("¿Esta seguro que desea eliminar?")){

        $.ajax({

            data: {'id':id},
            url: '/eliminar_direccion/',
            type: 'get',
            error:function(a,b,c){

                $('#alertas-ajax').addClass('alert');
                $('#alertas-ajax').addClass('alert-danger');
                document.getElementById('alertas-ajax').innerHTML = "<button type='button' class='close' data-dismiss='alert' aria-hidden='True'>&times;</button>Hubo un error de comunicación "+c+"</div>"
                console.log(c);
            }

        }).done(function(data){

            document.getElementById(row).parentNode.removeChild(document.getElementById(row));

        });

    }
    document.getElementById("demo").innerHTML=x;
}

$("#addressModal").on("shown.bs.modal",function(){
        google.maps.event.trigger(map,'resize');

    })

</script>
{% endblock %} {# /JS nivel 3 #}