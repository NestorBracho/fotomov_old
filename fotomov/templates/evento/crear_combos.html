{% extends 'tabla.html' %}
{% load bootstrap %}
{% block css %}
<link href="{{ STATIC_URL }}/css/smoothness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
{% endblock %}
{% block titulo %}
Crear combo
{% endblock %}
{% block seccion-contenido %}
<div class="col-md-12" style="margin-bottom: 10px"><div class="pull-left"><a href="/listar_combos/{{ iden }}/" class="btn btn-default"><i class="fa fa-chevron-left"></i> Combos</a></div></div>
<form method="POST" id="combos" action="" enctype="multipart/form-data" >{% csrf_token %}
    <div class="col-md-12">
        <div class="col-md-5" id="cuerpo">
            <div class="form-group">
                <label class="control-label " for="id_nombre_del_combo">

                    Nombre del combo

                </label>
                <div class=" ">
                    <input id="id_nombre_del_combo" class=" form-control" type="text" name="nombre" maxlength="200"></input>
                </div>
            </div>
            <div class="form-group">
                <label class="control-label " for="id_desc">

                    Descripci√≥n

                </label>
                <div class=" ">
                    <input id="id_desc" class="form-control" type="text" name="desc" maxlength="200"></input>
                </div>
            </div>
            <div class="form-group">
                <label class="control-label " for="id_costo_del_combo">

                    Costo del combo (Bs.)

                </label>
                <div class=" ">
                    <input id="id_costo_del_combo" onkeypress="return numero(event)" class="precio form-control" type="text" name="precio" maxlength="200" value="0"></input>
                </div>
            </div>
            <div class="form-group">
                <input type="button" onclick="enviar()" class="btn btn-primary btn-block" value="Guardar">
            </div>
        </div>
        <div class="panel panel-default table-responsive col-md-7">
            <div class="panel-body">
                <table class="table table-striped table-responsive" id="content">
                    <thead>
                        <th>Selec.</th>
                        <th>Producto</th>
                        <th>Costo (Bs.)</th>
                        <th>Cantidad</th>
                    </thead>
                    {% for producto in productos %}
                        <tr>
                            <td><input id="{{ producto.id }}-check" class="form-control check" type="checkbox" value="{{ producto.id }}" name="seleccionados"> </td>
                            <td>{{ producto.producto.nombre }}</td>
                            <td><span id="{{ producto.id }}-precio" class="costo">{{ producto.precio_produccion }}</span></td>
                            <td><input id="{{ producto.id }}-cantidad" type="text" onkeypress="return numero(event)" value="1" name="{{ producto.id }}-cantidad" class="spinner form-control" style="width: 50px"></td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td>No hay productos</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

    </div>
</form>
{% endblock %}
{% block js %}
<script type="text/javascript">

$(".spinner").spinner({min: 1, stop: function(event, ui){
        $("#id_costo_del_combo").val(0);
        $(".check:checked").each(function(){

            var iden = $(this).attr("id");
            iden = iden.split("-");
            iden = iden[0];

            $("#id_costo_del_combo").val(parseFloat($("#id_costo_del_combo").val())+parseFloat((parseFloat($("#"+iden+"-precio").html())*$("#"+iden+"-cantidad").val())));

        });
    }
});

$(".precio").spinner({min: 0});

$(".costo").each(function(){

    var aux = $(this).html();
    aux = aux.split(",");
    aux = aux[0]+"."+aux[1]
    $(this).html(aux);

});

$(".check").change(function(){

    var iden = $(this).attr("id");
    iden = iden.split("-");
    iden = iden[0];

    if ( $(this).prop("checked") ){

        $("#id_costo_del_combo").val(parseFloat($("#id_costo_del_combo").val())+parseFloat((parseFloat($("#"+iden+"-precio").html())*$("#"+iden+"-cantidad").val())));

    }else{

        $("#id_costo_del_combo").val(parseFloat($("#id_costo_del_combo").val())-parseFloat((parseFloat($("#"+iden+"-precio").html())*$("#"+iden+"-cantidad").val())));

    }

});

function numero(e){

    var codigo;
    codigo = (document.all) ? e.keyCode : e.which;

    if (codigo > 31 && (codigo < 48 || codigo > 57) && codigo != 46 ) {
        return false;
    }
    return true;
}

function enviar(){

    var prop=0;

    $(".check").each(function(){

        var iden = $(this).attr("id");
        iden = iden.split("-");
        iden = iden[0];

        $(this).val(iden+"-"+$("#"+iden+"-cantidad").val());

    });

    $(".check:checked").each(function(){

        $(this).attr("name", "check-"+prop);
        prop = prop + 1;

    });

    $("#cuerpo").append("<input type='hidden' name='numprop' value='"+prop+"'>");

    $("#combos").submit();

}

</script>
{% endblock %}