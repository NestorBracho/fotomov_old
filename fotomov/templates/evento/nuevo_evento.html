{% extends 'admin.html' %}
{% load bootstrap %}
{% block css %}
    <link href="{{ STATIC_URL }}/css/smoothness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
{% endblock %}
{% block seccion-contenido %}
<form method="POST" action="r" enctype="multipart/form-data">{% csrf_token %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4>Datos del evento</h4>
        </div>
        <div class="panel-body">
            <div class="col-sm-4">
                {{ formulario.nombre | bootstrap }}
            </div>
            <div class="col-sm-4">
                {{ formulario.macrocliente | bootstrap }}
            </div>
            <div class="col-sm-4">
                {{ formulario.encargado | bootstrap }}
            </div>
            <div class="col-sm-12">
                {{ formulario.descripcion | bootstrap }}
            </div>

        </div>
    </div>
    <div>
        <h4>Días</h4>
        <div>
            <div id="id_dias"></div>
            <input type="text" id="id_input_fecha" placeholder="Fecha..."/> <button type="button" class="btn btn-default" onclick="AgregarDia()">Agregar día</button>
        </div>
    </div>
</form>

<div id='dialog'></div>
<div id='inphid'></div>
{% endblock %}
{% block js %}
<script type="text/javascript">

 var dias = "0.0.0";

// From: http://www.w3schools.com/htmldom/met_table_insertrow.asp

window.onload = function(){

    $('#id_input_fecha').datepicker({ dateFormat: "dd/mm/yy" });
    if(document.getElementById("id_macrocliente").value<1){
        document.getElementById("id_encargado").innerHTML = "<option>---------</option>";
        document.getElementById("id_encargado").disabled = true;
    }else{
        ajax_encargado();
    }

}

$("#dialog").dialog("option", "hide");

$('#id_macrocliente').on('change',ajax_encargado);

function aucomloc(id_input){

    var ajax_loc = document.getElementById(id_input).value;
    var a=id_input;

    $.ajax({
        data:{'locacion':ajax_loc},
        url:'/locacion_ajax/',
        type:'GET'
    }).done(function(dominio){

        var locaciones_finales=[];

        for(var i=0; i<dominio.length; i++){
            locaciones_finales.push([dominio[i].fields.nombre].toString());
        }

         a = id_input.split('.');
         a = a[0]+"\\."+a[1]+"\\."+a[2];

        $('#'+a).autocomplete({
            source: locaciones_finales
        });

    });
}

function ajax_encargado(){

    var select_macro = $('#id_macrocliente').val();

    if(select_macro>0){
        $.ajax({

            beforeSend:function(){
                document.getElementById('id_encargado').innerHTML = '<option>Cargando...</option>';
            },
            data:{'id':select_macro},
            url:'/encargado_ajax/',
            type:'get'

        }).done(function(data){

            document.getElementById("id_encargado").disabled = false;
            document.getElementById("id_encargado").innerHTML = "<option>---------</option>";
            for(var i=0;i<data.length;i++){
                document.getElementById('id_encargado').innerHTML = document.getElementById('id_encargado').innerHTML+'<option value='+data[i].pk+'>'+data[i].fields.nombre+'</option>';
            }

        });
    }else{

        document.getElementById("id_encargado").innerHTML = "<option>---------</option>";
        document.getElementById("id_encargado").disabled = true;

    }

}

function AgregarDia(){

    var temp= dias.split(".");

    if(document.getElementById('id_input_fecha').value!=''){
        temp[0]=parseInt(temp[0]);
        temp[0] += 1;
        dias = temp[0]+"."+temp[1]+"."+temp[2];
        document.getElementById('id_dias').innerHTML += "<div class='panel panel-default table-responsive'><div class='panel-heading'><label id="+dias+" name=0>"+document.getElementById('id_input_fecha').value+"</label></div><div class='panel-body'><div id=tabla"+dias+"></div></hr><input type='text' onkeyup=aucomloc('input"+dias+"') id=input"+dias+" placeholder='Nombre de la locacion....' > <input type='button' onclick=AgregarLocacion('tabla"+dias+"','input"+dias+"','"+dias+"') value='Agregar Locacion'></div></div>";
        document.getElementById('id_input_fecha').value = '';
    }else{
        alert('vacio');
    }

}

function AgregarLocacion(tablaid,inputid,main){//<-hacer el ajax aqui de validacion de nombre de locacion

    var temp= main.split(".");
    var aux;
    var tempNombre = parseInt(document.getElementById(main).getAttribute('name'));
    var ajax_loc = document.getElementById(inputid).value;

    $.ajax({
        data:{'locacion':ajax_loc},
        url:'/locacion_ajax/',
        type:'GET',
        error:function(){
            if(confirm("La locacion no existe!\nDesea agregar a la libreta de direcciones?")){
                document.getElementById("dialog").innerHTML = "<iframe src='/libreta_direcciones/' seamless width='900' higth='900'></iframe>";
                $("#dialog").dialog({title:'Agregar direccion', hide:false});
            }
        }
    }).done(function(dominio){
        aux = dominio[0].fields.nombre.toString();

        if(aux==ajax_loc){

            tempNombre += 1;
            document.getElementById(main).setAttribute('name',tempNombre);
            temp[1]=parseInt(temp[1]);
            temp[1] += 1;
            main = temp[0]+"."+tempNombre+"."+temp[2];

            document.getElementById(tablaid).innerHTML += "</br><div><div class='col-sm-6'><label id="+main+" name=0>"+ajax_loc+"</label></div><div style='border-left: 1px solid #dedede;' class='col-sm-6' id=tabla"+main+"></div><div class='col-sm-12'  style='border-bottom: 1px solid #dedede;text-align: right'><input type='button' value='Agregar funcion' onclick=AgregarFuncion('tabla"+main+"','"+main+"')> </div></div>";

        }else{

            if(confirm("La locacion no existe!\nDesea agregar a la libreta de direcciones?")){
                document.getElementById("dialog").innerHTML = "<iframe src='/libreta_direcciones/' seamless width='100%' higth='100%'></iframe>";
                $("#dialog").dialog({title:'Agregar direccion', hide:false, minHeight: 600, minWidth: 900});
            }

        }
    });

    document.getElementById(inputid).value='';
}

function AgregarFuncion(tablaid,main){

    var nombre = document.getElementById(main).innerHTML;
    document.getElementById('dialog').innerHTML = "<div><label>Into el nombre de la funcion</label><input type='text' id= input"+main+" /><hr/><input type='button' value='Agregar' onclick=AgregarRegistroFuncion('"+tablaid+"','input"+main+"','"+main+"') /></div>";
    $("#dialog").dialog({title:nombre, hide:false, minHeight: 600, minWidth: 900});


}

function AgregarRegistroFuncion(tablaid,inputid,main){

    var tempNombre = parseInt(document.getElementById(main).getAttribute('name'));
    var temp = main.split('.');
    tempNombre += 1;
    document.getElementById(main).setAttribute('name',tempNombre);
    main = temp[0]+"."+temp[1]+"."+tempNombre;
    document.getElementById(tablaid).innerHTML += "<label id="+main+">"+document.getElementById(inputid).value+"</label></br>";
    $("#dialog").dialog("close");
}

</script>
{% endblock %}