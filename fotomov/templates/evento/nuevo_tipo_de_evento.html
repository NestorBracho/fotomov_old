{% extends 'tabla.html' %}
{% load bootstrap %}
{% block css %}
<link href="{{ STATIC_URL }}/css/smoothness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
<style type="text/css">

.table-responsive{

    max-height:150px;
    overflow-y: auto;

}

</style>
{% endblock %}
{% block titulo %}
Agregar tipo de evento
{% endblock %}
{% block seccion-contenido %}

<form method="POST" id="form-tipo-evento">{% csrf_token %}
    <div class="row">
        <div class="col-md-5">{{ formulario.nombre | bootstrap }}
                <div class="col-md-5 hidden-xs hidden-sm"></div>
        </div>
        <div class="col-md-7 table-responsive">
            <table class="table table-striped table-responsive table-hover">
                <thead><th colspan="2">Tipos de eventos</th></thead>
                {% for evento in eventos %}
                <tr id="te-{{ evento.id }}"><td><a href="/ver_tipo_evento/{{ evento.id }}/">{{ evento.nombre }}</a></td><td> <a class="btn btn-xs btn-danger" onclick="eliminarTipoEvento('{{ evento.id }}')">Eliminar</a>  <a class="btn btn-xs btn-success" href="/nuevo_tipo_de_evento/{{ evento.id }}/">Editar</a></td></tr>
                {% endfor %}
            </table>
        </div>
    </div>
    <div class="col-md-12">
        <hr>
        <h3>Tareas predefinidas por tipo de evento</h3>
        <table class="table  table-hover">
            <thead><th>Id</th><th>Tarea</th><th>Descripción de la tarea</th><th>Gerencia</th><th>Días</th><th>Prela a...</th></thead>
            <tbody {% if editado != '0' %} name="{{ tareas|length }}" {% else %} name="0" {% endif %} id="tabla-tareas">
            {% if editado != '0' %}
                {% for tarea in tareas %}
                    <tr id="{{ forloop.counter }}"><td>{{ forloop.counter }}</td><td><input class='form-control' type='text' name='nom-{{ forloop.counter }}' id='nom-{{ forloop.counter }}' placeholder='Nombre...' value='{{ tarea.nombre }}'></td><td><textarea class='form-control' name='desc-{{ forloop.counter }}' id='desc-{{ forloop.counter }}' placeholder='Tarea...'>{{ tarea.tarea }}</textarea></td><td><select class='form-control' name='select-staff-{{ forloop.counter }}' id='select-staff-{{ forloop.counter }}'><option value='0'>---------</option>{% for staf in staff %}<option value='{{ staf.id }}' {% if staf.id == tarea.asignado.id %}selected{% endif %}>{{ staf.nombre }}</option>{% endfor %}</select></td><td><input class="dias" name='dias-{{ forloop.counter }}' id='dias-{{ forloop.counter }}' value='{{ tarea.dias }}'><div><input onclick="set_dias_despues_evento('dias-{{ forloop.counter }}','True')" name='aod-{{ forloop.counter }}' value='True' checked='true' type='radio'><span> Antes del evento</span><br><input onclick="set_dias_despues_evento('dias-{{ forloop.counter }}','False')" name='aod-{{ forloop.counter }}' value='False' {% if tarea.dias < 0 %} checked {% endif %} type='radio'><span> Despues del evento</span></div></td><td><select class='form-control prelacion' id='prel-{{ forloop.counter }}' name='prel-{{ forloop.counter }}'><option value='0'>---</option></select></td></tr>
                {% endfor %}
            {% endif %}
            </tbody>
        </table>
        <input type="hidden" name="tareas" id="toDoList" {% if editado != '0' %} value="{{ tareas|length }}" {% else %} value="0" {% endif %}>
    </div>
    <div class="col-md-12">
        <a class="btn btn-danger" onclick="eliminarTarea()"><span class="glyphicon glyphicon-minus"></span> Eliminar tarea</a> <a onclick="agregarTarea()" class="btn btn-success"><span class="glyphicon glyphicon-plus"></span> Agregar tarea</a>
    </div>
    <div class="col-md-12 text-right">
        <input type='button' class="btn btn-default btn-primary" onclick="guardarTE()" value='Guardar'/>
    </div>
</form>
{% endblock %}
{% block js %}
<script type="text/javascript">

$(".prelacion").each(function(){

    var numTareas = "{{ tareas|length }}", iden = $(this).attr("id");
    numTareas = parseInt(numTareas);
    iden = iden.split("prel-");
    iden = iden[1]


    for(var i=0; i<numTareas; i++){

        if(iden != (i+1)){
            $(this).append("<option value='"+(i+1)+"'>"+(i+1)+"</option>");
        }

    }

    {% for prelacion in prelaciones %}

        if('{{ prelacion.es_prelada.id_aux }}'==iden){

            $(this).val('{{ prelacion.prela.id_aux }}');

        }

    {% endfor %}

});

$(".dias").each(function(){

    if(parseInt($(this).val())<0){
        $(this).val(parseInt($(this).val())*-1);
    }
    $(this).spinner({min:0});

});

function eliminarTipoEvento(iden){

    if(confirm("Eliminar este elemento puede traducirse en perder data importante de la base de datos y es altamente recomendable q no lo haga.\n ¿Está REALMENTE SEGURO que desea eliminar este elemento?")){

        if(confirm("Me temo que debo insistir en que reconsidere el eliminar este elemento. Esta acción puede que tenga altas repercuciones entre las que pueden destacar la eliminación de Eventos, Estadisticas, entre otras.\n De nuevo, ¿está REALMENTE SEGURO que desea eliminar este elemento?")){

            window.location.href = "/eliminar_tipo_evento/"+iden+"/";

        }

    }

}

function eliminarTarea(){

    var iden = parseInt(document.getElementById('tabla-tareas').getAttribute('name'));

    if(iden!=1){
        document.getElementById(iden).parentNode.removeChild(document.getElementById(iden));
    }else{
        document.getElementById('tabla-tareas').innerHTML = "";
    }

    iden--;
    document.getElementById('tabla-tareas').setAttribute('name',iden)
    document.getElementById('toDoList').setAttribute('value',iden);

    for(var i=1;i<iden+1;i++){

        document.getElementById("prel-"+i).innerHTML = "<option value='0'>---</option>";

        for(var k=1;k<iden+1;k++){

            if(k!=i){

                $("#prel-"+i).append("<option value='"+k+"'>"+k+"</option>");

            }

        }

    }

}

function agregarTarea(){

    var iden = parseInt(document.getElementById('tabla-tareas').getAttribute('name')), aux;
    iden++;
    document.getElementById('tabla-tareas').setAttribute('name',iden);

    $('#tabla-tareas').append("<tr id="+iden+"><td>"+iden+"</td><td><input class='form-control' type='text' name='nom-"+iden+"' id='nom-"+iden+"' placeholder='Nombre...'></td><td><textarea class='form-control' name='desc-"+iden+"' id='desc-"+iden+"' placeholder='Tarea...'></textarea></td><td><select class='form-control' name='select-staff-"+iden+"' id='select-staff-"+iden+"'><option value='0'>---------</option>{% for staf in staff %}<option value='{{ staf.id }}'>{{ staf.nombre }}</option>{% endfor %}</select></td><td><input name='dias-"+iden+"' id='dias-"+iden+"'><div><input onclick=set_dias_despues_evento('dias-"+iden+"','True') name='aod-"+iden+"' value='True' checked='true' type='radio'><span> Antes del evento</span><br><input onclick=set_dias_despues_evento('dias-"+iden+"','False') name='aod-"+iden+"' value='False' type='radio'><span> Despues del evento</span></div></td><td><select class='form-control' id='prel-"+iden+"' name='prel-"+iden+"'><option value='0'>---</option></select></td></tr>");

    document.getElementById('toDoList').setAttribute('value',iden);

    for(var i=1;i<iden;i++){

        $("#prel-"+i).append("<option value='"+iden+"'>"+iden+"</option>");
        $("#prel-"+iden).append("<option value='"+i+"'>"+i+"</option>");

    }

    $("#dias-"+iden).spinner({min:0});
    $("#dias-"+iden).spinner('value',14);
}

function guardarTE(){

    var total = document.getElementById("toDoList").value;
    var flag = true, nom = [], desc= [], staff= [], aux;

    for(var a=1; a<total+1;a++){

        if(document.getElementById(a)){

            document.getElementById(a).setAttribute('class','');

        }

    }

    for(var i=1; i<total+1;i++){

        if(document.getElementById("nom-"+i)){

            if(document.getElementById("nom-"+i).value == ''){

                flag = false;
                nom += i;
                document.getElementById(i).setAttribute('class','danger');

            }

            if(document.getElementById("desc-"+i).value == ''){

                flag = false;
                desc += i;
                document.getElementById(i).setAttribute('class','danger');

            }

            if(document.getElementById("select-staff-"+i).value == '0'){

                flag = false;
                staff += i;
                document.getElementById(i).setAttribute('class','danger');

            }
        }
    }

    if(document.getElementById("id_nombre").value == ''){

        flag = false;
        alert("El nombre del tipo de evento no puede estar vacio.");

    }

    if(flag == false){

        if(nom.length==1){

            alert("El nombre en la tarea "+nom[0]+" no puede estar vacio.");

        }else if(nom.length>1){

            aux = '';

            for(var p = 0; p<nom.length; p++){

                aux += nom[p];
                aux += ", ";

            }

            alert("Los nombres en las tareas "+aux+" no pueden estar vacios.");

        }

        if(desc.length==1){

            alert("La descripción en la tarea "+desc[0]+" no puede estar vacia.");

        }else if(desc.length>1){

            aux = '';

            for(var p = 0; p<desc.length; p++){

                aux += desc[p];
                aux += ", ";

            }

            alert("Las descripciones en las tareas "+aux+" no pueden estar vacias.");

        }

        if(staff.length==1){

            alert("Debe seleccionar un tipo de staff en la tarea "+staff[0]);

        }else if(nom.length>1){

            aux = '';

            for(var p = 0; p<staff.length; p++){

                aux += staff[p];
                aux += ", ";

            }

            alert("Debe seleccionar un tipo de staff en las tareas "+aux);

        }

    }else{

        document.forms['form-tipo-evento'].submit();

    }

}

function set_dias_despues_evento(iden,val){

    if(val == "True"){

        $("#"+iden).spinner('value',14);

    }else{

        $("#"+iden).spinner('value',1);

    }

}

</script>
{% endblock %}