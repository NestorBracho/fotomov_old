{% extends "venta.html" %}
{% block css %}
<link href="{{ STATIC_URL }}/css/smoothness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
<style type="text/css">

ul {
    display: block;
    list-style-type: disc;
    -webkit-margin-before: 1em;
    -webkit-margin-after: 1em;
    -webkit-margin-start: 0px;
    -webkit-margin-end: 0px;
    -webkit-padding-start: 0px;
    padding-left: 5px;
}

.principal-fotos{

    max-height:600px;
    overflow-y: auto;

}

</style>
{% endblock %}
{% block seccion-contenido %}
<div>
    <div class="panel panel-default col-md-9 principal-fotos">
        <div class="panel-body">
            {% for imagen in imagenes %}
                <div class="col-md-3 text-center">
                    <a data-toggle="modal" data-target="#Foto" onclick="abrirFoto('{{ imagen }}')" >
                        <img src="{{MEDIA_URL}}{{ short_current }}/{{ imagen }}"
                             class="imagen img-responsive img-thumbnail" name="{{ imagen }}" style="max-height: 120px"
                        >
                    </a>
                    <div class="hidden">
                        <select id="producto{{ imagen }}">
                        {% for producto in productos %}
                            <option value="{{ producto.id }}">{{ producto.producto.nombre }}</option>
                        {% endfor %}
                        </select>
                        <input type="text" id="cantidad{{ imagen }}">
                        <input type="text" id="comentario{{ imagen }}">
                        <button onclick="ajax_guardar('{{ imagen }}', '{{ dir_actual.pedido.id }}')">Agregar</button>
                    </div>
                </div>
                {% if forloop.counter|divisibleby:4 %}<div class="col-md-12" style="margin-top: 5px"></div>{% endif %}
            {% endfor %}
        </div>
    </div>
</div>
<aside id="lista_compra">
    <div class="panel panel-default col-md-3">
        <div class="panel-body">
            <div class="col-md-12 row">
                <table class="table table-striped table-responsive">
                    <tbody id="agregados">
                    {% for agregado in productos_pedidos %}
                        <tr>
                            <td><a data-toggle="modal" data-target="#Foto" onclick="abrirFotoProducto('{{ agregado.1 }}','{{ agregado.0.cantidad }}','{{ agregado.0.producto.producto.id }}','{{ agregado.0.comentario }}')"><img src="{{MEDIA_URL}}{{ short_current }}/{{ agregado.1 }}"
                             style="max-height: 30px; max-width: 40px"
                            ></a></td>
                            <td>{{ agregado.0.cantidad }} {{ agregado.0.producto.producto.nombre }}</td>
                            <td><a class="btn btn-danger btn-xs" onclick="deleteAlert('{{ agregado.0.id }}')">eliminar</a></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <a class="btn btn-primary" href="/asignar_combos/{{evento.id}}/{{ id_funcion }}/{{ dir_actual.pedido.id }}">Generar Ticket</a>
            </div>
        </div>
    </div>
</aside>
<div class="modal fade" id="Foto" tabindex="-1" role="dialog" aria-labelledbby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-img">
        <div class="modal-content">
            <div class="modal-header" style="display: none" id="modal-header">
                <div class='alert alert-success'>Producto agregado exitosamente!</div>
            </div>
            <div class="modal-body text-center" id="modal-body">
            </div>
            <div class="modal-footer" id="modal-footer">
                <div class="row">
                    <div class="col-md-6">
                        <select class="form-control" id="modal-producto">
                            <option value="0">-----------</option>
                        {% for producto in productos %}
                            <option value="{{ producto.id }}">{{ producto.producto.nombre }}</option>
                        {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-1 text-center">X</div>
                    <div class="col-md-5"><input onkeypress="return numero(event)" id="modal-spinner" class="form-control" type="text" value="0"></div>
                    <div class="col-md-12" style="margin-top: 5px"><input id="modal-comentarios" class="form-control" type="text" placeholder="Comentarios"></div>
                    <div class="col-md-12"><a id="agregarFotoModal" onclick="agregarModal()" class="btn btn-primary btn-block" style="margin-top: 5px">Agregar</a></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<script type="text/javascript">

window.onload = function(){

    $("#modal-spinner").spinner({min:0});

}

$("#Foto").on('hide.bs.modal', function(event){
        $("#modal-spinner").val(0);
        $("#modal-comentarios").val('');
    });


function abrirFoto(imagen){
    var interno = '<div class="row"><div class="col-md-1"><a onclick="anterior()" class="btn btn-default"><i class="fa fa-chevron-left"></i></a></div><div class="col-md-10" ><img id="img" name="' + imagen + '" src="{{MEDIA_URL}}{{ short_current }}/' + imagen + '" class=\'img-responsive\'></img></div><div class="col-md-1"><a class="btn btn-default" onclick="siguiente()"><i class="fa fa-chevron-right"></i></a></div></div>';
    document.getElementById('modal-body').innerHTML = interno;
    $("#agregarFotoModal").attr("onclick","agregarModal('"+imagen+"')");

}

function abrirFotoProducto(nomb, cant, iden, comment){

    //$("#modal-spinner").val(cant);
    //$("#modal-comentarios").val(comment);
    //$("#modal-producto").val(iden);

    abrirFoto(nomb);

}

function ajax_guardar(imagen, id_pedido){
    //alert('{{ short_current }}');
    var cantaux = '#cantidad' + imagen;
    var cantidad = document.getElementById('cantidad'+imagen).value;
    var comentario = document.getElementById('comentario'+imagen).value;
    var producto = document.getElementById('producto'+imagen);
    var producto_valor = producto.options[producto.selectedIndex].innerHTML;
    $.ajax({
        data:{'cantidad': cantidad, 'producto': producto.value, 'imagen': imagen, 'id_pedido': id_pedido, 'comentario': comentario},
        url:'/agregar_item/',
        type: 'get',
        error:function(a,b,c){

            $('#alertas-ajax').addClass('alert');
            $('#alertas-ajax').addClass('alert-danger');
            document.getElementById('alertas-ajax').innerHTML = "<button type='button' class='close' data-dismiss='alert' aria-hidden='True'>&times;</button>Hubo un error de comunicación "+c+"</div>"
            console.log(c);
        }

    }).done(function(data){
        for(var i=0; i<data.length; i++){
            $('#agregados').append('<tr><td><a data-toggle="modal" data-target="#Foto" onclick="abrirFotoProducto(\''+imagen+'\',\''+data[i].fields.cantidad+'\',\''+producto.value+'\',\''+data[i].fields.comentario+'\')"><img src="{{MEDIA_URL}}{{ short_current }}/'+imagen+'"style="max-height: 30px; max-width: 40px"></a></td><td>' + data[i].fields.cantidad + ' ' + producto_valor + '</td><td><a class=\"btn btn-danger btn-xs\" onclick=deleteAlert(\''+ data[i].pk +'\')>eliminar</a></td></tr>');
            //$('#agregados').append("ion('"+ data[i].fields.nombre +"')>"+ data[i].fields.direccion +"</td><td><button type=\"button\" class=\"btn btn-default btn-danger btn-xs\" onclick=\"deleteAlert(" + data[i].pk + ")\">Eliminaaaaaaaaaaaaaar</button></td></tr>");
        }

        /*if(document.getElementById("toto") != null){
            document.getElementById(document.getElementById("toto").value).value = data[0].fields.nombre;
            document.getElementById("close").click();
        }*/
    });
}

function deleteAlert(id){

    var r=confirm("¿Esta seguro que desea eliminar?");
    if (r==true){

        var string1 = "/eliminar_productoeventopedido/";
        window.location.assign(string1 + id + "/" + "{{ id_funcion }}")

    }
    document.getElementById("demo").innerHTML=x;
}

function siguiente(){

    var actual = $("#img").attr("name");
    var flag = false;
    var auxflag = false;

    $(".imagen").each(function(){

        if(flag==true){

            $("#modal-comentarios").val("");
            $("#modal-spinner").val(0);
            
            $("#img").attr("src",$(this).attr("src"));
            $("#img").attr("name",$(this).attr("name"));
            $("#agregarFotoModal").attr("onclick","agregarModal('"+$(this).attr("name")+"')");
            auxflag = true;
            return false;

        }

        if(actual == $(this).attr("name")){
            flag = true;
        }

    });

    if(auxflag == false){

        $(".imagen").each(function(){

            $("#modal-comentarios").val("");
            $("#modal-spinner").val(0);

            $("#img").attr("src",$(this).attr("src"));
            $("#img").attr("name",$(this).attr("name"));
            $("#agregarFotoModal").attr("onclick","agregarModal('"+$(this).attr("name")+"')");
            auxflag = true;
            return false;

        });

    }

}

function anterior(){

    var actual = $("#img").attr("name");
    var sourc, nam;

    $(".imagen").each(function(){

        sourc=$(this).attr("src");
        nam=$(this).attr("name");
        $("#agregarFotoModal").attr("onclick","agregarModal('"+nam+"')");

    });

    $(".imagen").each(function(){

        if(actual == $(this).attr("name")){

            $("#modal-comentarios").val("");
            $("#modal-spinner").val(0);

            $("#img").attr("src",sourc);
            $("#img").attr("name",nam);
            $("#agregarFotoModal").attr("onclick","agregarModal('"+nam+"')");

        }

        sourc=$(this).attr("src");
        nam=$(this).attr("name");

    });


}

function numero(e) {

    var codigo;

    codigo = (document.all) ? e.keyCode : e.which;

    if (codigo > 31 && (codigo < 48 || codigo > 57) && codigo != 46 ) {

        return false;

    }

    return true;
}

function agregarModal(iden){

    if($("#modal-producto").val()=='0'){

        alert("Debe seleccionar algún producto");

    }else if($("#modal-spinner").val()==0){

        alert("La cantidad del producto no puede ser 0");

    }else{
        document.getElementById('cantidad'+iden).value = $("#modal-spinner").val();
        document.getElementById('comentario'+iden).value = $("#modal-comentarios").val();
        document.getElementById('producto'+iden).value = $("#modal-producto").val();

        ajax_guardar(iden, "{{ dir_actual.pedido.id }}");

        $("#modal-producto").val('0');
        $("#modal-spinner").val(0);
        $("#modal-comentarios").val("");

        $("#modal-header").fadeIn();

        setTimeout(function(){

            $("#modal-header").fadeOut();

        },1500);
    }

}
</script>
{% endblock %}
