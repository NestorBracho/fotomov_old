{% extends 'tabla.html' %}
{% load bootstrap %}
{% block titulo %}
Generar pedido
{% endblock %}
{% block seccion-contenido%}
<form id="generar_pedido" method="POST">{% csrf_token %}
    <div class="col-xs-12 col-md-6">
        {% if cliente == None %}
        <div class="col-xs-12 col-md-12">
            <div class="form-group">
                <label class="control-label" for="id_nombres_cliente">Nombres</label>
                <input type="text" id="id_nombres_cliente" name="nombres_cliente" class="form-control">
            </div>
        </div>
        <div class="col-xs-12 col-md-12">
            <div class="form-group">
                <label class="control-label" for="id_apellidos_cliente">Apellidos</label>
                <input type="text" id="id_apellidos_cliente" name="apellidos_cliente" class="form-control">
            </div>
        </div>
        <div class="col-xs-12 col-md-12">
            <div class="form-group ">
                <label class="control-label" for="id_cedula_cliente">Número de cedula del cliente</label>
                <input type="text" id="id_cedula_cliente" name="cedula_cliente" class="form-control">
            </div>
        </div>
        <div class="col-xs-12 col-md-12">
            <div class="form-group ">
                <label class="control-label" for="id_rif_cliente">R.I.F. del cliente</label>
                <input type="text" id="id_rif_cliente" name="rif_cliente" class="form-control">
            </div>
        </div>
        <div class="col-xs-12 col-md-12">
            <div class="form-group">
                <label class="control-label" for="id_telefono_cliente">Número telefono del cliente</label>
                <input type="text" id="id_telefono_cliente" name="telefono_cliente" class="form-control">
            </div>
        </div>
        <div class="col-xs-12 col-md-12">
            <div class="form-group">
                <label class="control-label" for="id_mail_cliente">Email del cliente</label>
                <input type="text" id="id_mail_cliente" name="mail_cliente" class="form-control">
            </div>
        </div>
        <div class="col-xs-12 col-md-12">
            <div class="form-group">
                <label class="control-label" for="id_direccion_fiscal_cliente">Direccion fiscal del cliente</label>
                <input type="text" id="id_direccion_fiscal_cliente" name="direccion_fiscal_cliente" class="form-control">
            </div>
        </div>
        {% else %}
        <div class="col-xs-12 col-md-12 table-responsive">
            <table class="table ">
                <thead><th colspan="2">{{ cliente.nombres }} {{ cliente.apellidos }} - {{ cliente.cedula }}</th></thead>
                <tr><td>Email: {{ cliente.email }}</td><td>Telefono: {{ cliente.telefono }}</td></tr>
                <tr><td>Direccion: {{ cliente.direccion_fiscal }}</td><td>Rif: {{ cliente.rif }}</td></tr>
            </table>
        </div>
        {% endif %}
        <div class="col-xs-12 col-md-12">
            {{ formulario.id_fiscal | bootstrap}}
        </div>
        <div class="col-xs-12 col-md-12">
            {{ formulario.tlf_fiscal | bootstrap}}
        </div>
        <div class="col-xs-12 col-md-12">
            {{ formulario.razon_social | bootstrap}}
        </div>
        <div class="col-xs-12 col-md-12">
            {{ formulario.direccion_fiscal | bootstrap}}
        </div>
        <div class="col-xs-12 col-md-12">
            {{ formulario.envio | bootstrap }}
        </div>
        <div id="dir_envio" class="col-xs-12 col-md-12">
            <label class="control-label  " for="id_direccion_entrega">Direccion entrega</label>
                <div class=" ">
                    <textarea class=" form-control" cols="40" id="id_direccion_entrega" name="direccion_entrega" rows="10">{{ pedido_actual.direccion_entrega }}</textarea>
                </div>
        </div>
        <div class="col-xs-12 text-right">
                <input type='button' onclick="generarPedido()" class="btn btn-default btn-primary" value='Generar'/>
            <div class="col-md-6 hidden-xs hidden-sm"></div>
        </div>
    </div>
    <div class="col-xs-12 col-md-6 table-responsive">
        <table class="table ">
            <thead><th>Cant.</th><th>Produc.</th><th>Precio</th><th>Eliminar</th></thead>
            {% for pedido in pedidos %}
            <tr id="tr-{{ pedido.id }}"><td>{{ pedido.cantidad }}</td><td>{{ pedido.producto.producto.nombre }}</td><td id="total-{{ pedido.id }}">{{ pedido.producto.precio }}</td><td class="text-center" id="borrar-{{ pedido.id }}"></td></tr>
            {% endfor %}
        </table>
    </div>
    <div class="col-xs-12 col-md-6">
        Total: <input class="form-control" type="text" name="total_input" id="total_input" value="">
    </div>



    <div class="col-xs-12 col-md-6 table-responsive">
    {% if mensaje.error %}
    <div class="alert alert-danger">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="True">&times;</button>
        {{ mensaje.text }}
    </div>
    {% endif %}
    <div id="formsets">
        {{ pagosForms.management_form }}
        {% for form in pagosForms %}
            {{ form | bootstrap }}
        {% endfor %}

    </div>
    <div class="col-xs-12 col-md-6">
        <button type="button" id="agregar_pago" class="btn btn-default">Agregar otro pago</button>
    </div>

        <!--  <table id="tipos_pagos" class="table ">
            <thead><th>Tipo</th><th>Monto</th><th>Referencia</th><th>Eliminar</th></thead>
            <tr>
                <td name="tipo" >
                    <select class="form-control">
                    </select>
                </td>
                <td name="monto"><input size="1" style="font-size:24px;" class=" form-control" type="text"></td>
                <td name="referencia"><input class=" form-control" type="text"></td>
                <td><input class=" form-control" type="text"><</td>
            </tr>
        </table> -->
        <!--<span id="total"></span> -->
    </div>
</form>

<div class="modal fade" id="Foto" tabindex="-1" role="dialog" aria-labelledbby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-img">
        <div class="modal-content">
            <div class="modal-header" id="modal-header">
                <button id="close" type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            </div>
            <div class="modal-body text-center" id="modal-body">
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block js %}
<script src="{{STATIC_URL}}js/agregar_formsets.js"></script>
<script type="text/javascript">
window.onload = function(){
    var subtotal, total = 0, url_aux;

    {% if cliente == None %}
        $('#id_cedula_cliente').val("{{ ced }}");
    {% endif %}

    {% for pedido in pedidos %}

        url_aux = "{{ pedido.ruta }}";
        url_aux = url_aux.split('/fotomov_imagenes/');
        url_aux = url_aux[1];

        $('#borrar-{{ pedido.id }}').html('<a data-toggle="modal" data-target="#Foto" onclick=abrirFoto("{{MEDIA_URL}}'+url_aux+'") ><img src="{{MEDIA_URL}}'+url_aux+'" width="50"></a> <a onclick=borrarProducto("tr-{{ pedido.id }}")><span class="fa fa-leaf fa-fw"></span></a>');

        subtotal = parseInt("{{ pedido.cantidad }}")*parseInt("{{ pedido.producto.precio }}");
        total += subtotal;

        document.getElementById("total-{{ pedido.id }}").innerHTML = subtotal;


    {% endfor %}
    document.getElementById("total_input").value = total;

    if (document.getElementById("id_envio").value == 0){
        $("#dir_envio").hide();
    }

}

$(document).ready(function(){
    var options = [
        {
          label: '---------',
          value: ''
        },
        {% for tipo_pago in tipos_pago %}
            {
                label: '{{tipo_pago}}',
                value: {{tipo_pago.id}},
                discount: '{{ tipo_pago.descuento }}'

            },
        {% endfor %}
   ]

    // Funciones para las acciones de los formsets
    $('#agregar_pago').on('click',function(event){
        event.preventDefault();
        agregarFormset(options);
    });

  $("#id_envio").change(function(){
      if (document.getElementById("id_envio").value == 0){
          $("#dir_envio").hide();
      }else{
          $("#dir_envio").show();
      }

  });

  $("#id_form-0-tipo_pago").change(function(){
        verificar()
  });

  $("#id_tipo_pago").change(function(){
      if (document.getElementById("id_tipo_pago").value == ""){
          $("#tipo_pago").hide();
      }else{
          $("#tipo_pago").show();
      }

  });
});


function verificar(){
    var options = [
        {% for tipo_pago in tipos_pago %}
            {% if tipo_pago.descuento == False %}
                {{ tipo_pago.id }},
            {% endif %}
        {% endfor %}
    ]
    var flag = "True";
    var total = parseInt($('#id_form-TOTAL_FORMS').val(),10);
    var i = 0;

    while (i<total){
        var paid = document.getElementById('id_form-'+i+'-tipo_pago').value;
        $.each(options, function(index, option){
           if (option == paid){
               flag="False";
           }
        });
        i++;
    }
    if (flag == "False"){
        document.getElementById('total_input').readOnly = true;
    }else{
        document.getElementById('total_input').readOnly = false;
    }
    {% comment %}for (var i = 0, len = options.length, text = ""; i < len; i++) {
        text += cars[i] + "<br>";
    }{% endcomment %}
}

function borrarProducto(iden){

    var idPEV = iden.split('-');
    idPEV = idPEV[1];
    var subt = parseFloat($('#total-'+idPEV).html());
    var total = $('#total').html().split(" ");
    if(confirm("¿Esta seguro que desea borrar este producto del pedido?")){
        total = total[1];
        total = parseFloat(total);
        total = total - subt;
        $('#total').html('Total: '+total+' Bs.');

        $.ajax({

            url:'/eliminar_productoeventopedido_en_generarpedido/',
            data:{'iden': idPEV},
            type:'GET'

        }).done(function(data){

            $("#"+iden).fadeOut();
            window.setTimeout(function(){document.getElementById(iden).parentNode.removeChild(document.getElementById(iden))},3000);

        });
    }
}

function abrirFoto(url){

    $('#modal-body').html('<img src='+url+'></img>');

}

function generarPedido(){

    document.getElementById('generar_pedido').submit();
}

function agregar_tipo_pago(){

}

</script>
{% endblock %}