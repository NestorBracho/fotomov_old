{% extends 'tabla.html' %}
{% load bootstrap %}
{% block titulo %}
Lotes en edición
{% endblock %}
{% block subtitulo %}
<h4>Pedido: {{pedido.cliente.nombres}} {{pedido.cliente.apellidos}} - {{pedido.codigo}}</h4>
{% endblock %}
{% block seccion-contenido%}
<a href="/edicion_pedido/{{pedido.id}}/" class="btn btn-xs btn-default">volver</a>
<div class="col-xs-12 col-md-12">
    <table class="table table-striped table-hover table-responsive ">
        <thead><th>Foto</th><th>Producto</th><th>Cantidad</th><th>Comentarios</th><th>Estado</th><th>Acciones</th></thead>
        <tbody id="body-edicion">
        {% for producto in edicion %}
        <tr><td id="img-{{producto.id}}"></td><td>{{ producto.producto.producto.nombre }}</td><td>{{ producto.cantidad }}</td><td><a class="btn btn-xs btn-default" data-toggle="modal" data-target="#Comentarios" onclick=verComentario('{{ producto.id }}') >Ver</a></td><td id="estado-{{ producto.id }}">Pendiente</td><td><a id="btn-producto-{{producto.id}}" class="btn btn-xs btn-default" onclick=estadoListo('{{ producto.id }}') >Cambiar estado a Listo</a></td></tr>
        {% endfor %}
        {% for editado in editados %}
        <tr><td id="img-{{editado.id}}"></td><td>{{ editado.producto.producto.nombre }}</td><td>{{ editado.cantidad }}</td><td><a class="btn btn-xs btn-default" data-toggle="modal" data-target="#Comentarios" onclick=verComentario('{{ editado.id }}') >Ver</a></td><td id="estado-{{ editado.id }}">Listo</td><td><a id="btn-producto-{{editado.id}}" class="btn btn-xs btn-default" onclick=estadoListo('{{ producto.id }}') >Cambiar estado a Pendiente</a></td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="Comentarios" tabindex="-1" role="dialog" aria-labelledbby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="modal-header">
                <button id="close" type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            </div>
            <div class="modal-body text-center" id="modal-body">
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<script type="text/javascript">

window.onload = function(){

    var url_aux;

    {% for producto in edicion %}

        url_aux = "{{ producto.ruta }}";
        url_aux = url_aux.split('/fotomov_imagenes/');
        url_aux = url_aux[1];

        $('#img-{{ producto.id }}').html('<img src="{{MEDIA_URL}}'+url_aux+'" width="50"></img>');

    {% endfor %}

    {% for editado in editados %}

        url_aux = "{{ editado.ruta }}";
        url_aux = url_aux.split('/fotomov_imagenes/');
        url_aux = url_aux[1];

        $('#img-{{ editado.id }}').html('<img src="{{MEDIA_URL}}'+url_aux+'" width="50"></img>');

    {% endfor %}

}

function verComentario(iden){

    {% for producto in edicion %}

        if('{{ producto.id }}' == iden){

            $('#modal-body').html('{{ producto.comentario }}');

        }

    {% endfor %}

    {% for editado in editados %}

        if('{{ editado.id }}' == iden){

            $('#modal-body').html('{{ editado.comentario }}');

        }

    {% endfor %}

}

function estadoListo(iden){

    if(confirm("Una vez que el estado pase a Listo, no podras revertirlo.\n¿Estas seguro que esta foto ya esta editada?")){

        $.ajax({

            url:'/cambiar_estado_producto_edicion->editado/',
            data:{'iden':iden},
            type:'get'

        }).done(function(data){

            if(data.estado == "Editado"){

                $('#estado-'+iden).html('Listo');
                $('#btn-producto-'+iden).html('Cambiar estado a Pendiente');

            }else{

                $('#estado-'+iden).html('Pendiente');
                $('#btn-producto-'+iden).html('Cambiar estado a Listo');

            }

        });

    }

}

</script>
{% endblock %}